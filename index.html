<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kj√∏rebok - Forest People</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Arial, sans-serif; background:#f5f5f5; padding:10px; }
    .container { max-width: 900px; margin:0 auto; background:#fff; border-radius:8px; box-shadow:0 2px 10px rgba(0,0,0,.08); overflow:hidden; }
    .header { background:#2c3e50; color:#fff; padding:20px; text-align:center; }
    .vehicle-info { background:#34495e; color:#fff; padding:10px 20px; font-size:14px; }

    .login-screen { padding:32px 20px; text-align:center; }
    .login-form { max-width:320px; margin:0 auto; }
    .form-input { width:100%; padding:12px; margin:10px 0; border:2px solid #ddd; border-radius:6px; font-size:16px; }

    .btn { background:#3498db; color:#fff; border:none; padding:12px 16px; border-radius:6px; cursor:pointer; font-size:16px; margin:8px 4px; }
    .btn:hover { background:#2980b9; }
    .btn:disabled { background:#bdc3c7; cursor:not-allowed; }
    .btn-success { background:#27ae60; }
    .btn-success:hover { background:#229954; }
    .btn-edit { background:#f39c12; }
    .btn-edit:hover { background:#e67e22; }
    .btn-danger { background:#e74c3c; }
    .btn-danger:hover { background:#c0392b; }
    .btn-secondary { background:#6c757d; }
    .btn-secondary:hover { background:#5a6268; }
    .btn-warning { background:#f39c12; color:#fff; text-decoration:none; display:inline-block; }

    .main-content { padding:20px; display:none; }
    .form-group { margin-bottom:14px; }
    .form-row { display:flex; gap:10px; flex-wrap:wrap; }
    .form-col { flex:1; min-width:200px; }
    label { display:block; margin-bottom:6px; font-weight:700; color:#333; }
    input, select { width:100%; padding:10px; border:1px solid #ddd; border-radius:6px; font-size:16px; }

    .checkbox-group { display:flex; align-items:center; gap:8px; margin-top:6px; }
    .checkbox-group input[type="checkbox"] { width:auto; margin:0; }

    .auto-filled { background:#e8f5e8; border-color:#28a745; }
    .auto-fill-notice { background:#d4edda; color:#155724; padding:8px; border-radius:6px; margin:6px 0 10px; font-size:12px; border-left:3px solid #28a745; }

    .user-info { background:#d4edda; color:#155724; padding:10px; border-radius:6px; margin:10px 0; border-left:4px solid #28a745; }
    .stats { background:#ecf0f1; padding:14px; border-radius:6px; margin:16px 0; }
    .year-selector { margin:8px 0; }
    .year-selector input { width:130px; }

    .loading { text-align:center; padding:16px; color:#666; }
    .error { background:#f8d7da; color:#721c24; padding:12px; border-radius:6px; margin:10px 0; font-size:14px; }
    .warning { background:#fff3cd; color:#856404; padding:12px; border-radius:6px; margin:10px 0; border-left:4px solid #ffc107; }
    .info { background:#d1ecf1; color:#0c5460; padding:12px; border-radius:6px; margin:10px 0; border-left:4px solid #17a2b8; }
    .success { background:#d4edda; color:#155724; padding:12px; border-radius:6px; margin:10px 0; border-left:4px solid #28a745; }
    .editing-notice { background:#fff3cd; color:#856404; padding:10px; border-radius:6px; margin:10px 0; display:none; }

    /* Table wrapper for horizontal scroll on small screens (fix for iOS Chrome) */
    .table-wrapper { width:100%; overflow-x:auto; -webkit-overflow-scrolling: touch; border:1px solid #eee; border-radius:6px; }
    .records-table { width:100%; border-collapse:collapse; min-width:900px; font-size:14px; }
    .records-table th, .records-table td { border:1px solid #ddd; padding:8px; text-align:left; white-space:nowrap; }
    .records-table th { background:#f8f9fa; }
    .records-table tr:nth-child(even) { background:#fafafa; }
    .actions-cell { position: sticky; right:0; background: #fff; }
    /* On very small screens, make actions sticky for easy reach */
    @media (max-width: 600px) {
      .actions-cell { position: sticky; right: 0; background:#fff; box-shadow:-6px 0 8px -6px rgba(0,0,0,.08); }
    }

    .action-btn { color:#fff; border:none; padding:6px 8px; border-radius:4px; cursor:pointer; font-size:12px; margin:2px 2px; display:inline-block; }

    @media (max-width: 600px) {
      .form-row { flex-direction:column; }
      .btn { width:100%; margin:6px 0; }
    }

    .badge {
      display:inline-block; padding:2px 6px; border-radius:10px; font-size:11px; font-weight:700;
    }
    .badge-open { background:#fff3cd; color:#856404; border:1px solid #ffe08a; }
    .badge-complete { background:#d4edda; color:#155724; border:1px solid #b7dfb9; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header"><h1>Kj√∏rebok</h1></div>
    <div class="vehicle-info"><strong>Toyota Hilux 2010</strong> | Reg.nr: PP87332 | Forest People</div>

    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
      <div id="loginForm">
        <h2>Logg inn</h2>
        <div class="login-form">
          <input type="email" id="loginEmail" class="form-input" placeholder="E-post" required>
          <input type="password" id="loginPassword" class="form-input" placeholder="Passord" required>
          <button class="btn" onclick="loginUser()" id="loginBtn">Logg inn</button>
          <div class="toggle-link" onclick="toggleToRegister()">Ny bruker? Registrer deg her</div>
        </div>
      </div>

      <div id="registerForm" style="display:none;">
        <h2>Registrer ny bruker</h2>
        <div class="login-form">
          <input type="email" id="registerEmail" class="form-input" placeholder="E-post" required>
          <input type="password" id="registerPassword" class="form-input" placeholder="Passord (min 6 tegn)" required>
          <input type="text" id="registerName" class="form-input" placeholder="Navn (PJI eller LMK)" required>
          <button class="btn btn-success" onclick="registerUser()" id="registerBtn">Registrer</button>
          <div class="toggle-link" onclick="toggleToLogin()">Har allerede konto? Logg inn her</div>
        </div>
      </div>

      <div id="authError" class="error" style="display:none;"><div id="authErrorMessage"></div></div>
      <div id="authSuccess" class="success" style="display:none;"><div id="authSuccessMessage"></div></div>

      <div class="info" style="margin-top: 20px;">
        <strong>üîí Sikker innlogging</strong>
        <p>Appen bruker Firebase Authentication. Du trenger bare √• logge inn √©n gang per enhet.</p>
      </div>
    </div>

    <!-- Main Content -->
    <div id="mainContent" class="main-content">
      <div class="user-info">
        <strong>üë§ Innlogget som:</strong> <span id="currentUserEmail"></span>
        <button class="btn btn-secondary" onclick="logoutUser()" style="float:right; padding:6px 10px; font-size:12px;">Logg ut</button>
        <div style="clear:both;"></div>
      </div>

      <div class="stats">
        <h3>√Örsoversikt</h3>
        <div id="yearStats">
          <p>Turer totalt: <span id="totalTrips">0</span></p>
          <p>Kilometer totalt: <span id="totalDistance">0</span> km</p>
        </div>
        <div class="year-selector">
          <label for="exportYear"><strong>Velg √•r for PDF-eksport:</strong></label>
          <input type="number" id="exportYear" min="2020" max="2035">
        </div>
        <button class="btn btn-success" onclick="exportToPDF()">Eksporter PDF til regnskap</button>
      </div>

      <div id="loadingMessage" class="loading">Kobler til databasen...</div>
      <div id="errorMessage" class="error" style="display:none;">
        <strong>‚ùå Feil ved tilkobling til database</strong>
        <div id="errorDetails"></div>
      </div>

      <div id="indexWarning" class="warning" style="display:none;">
        <strong>‚ö†Ô∏è Database-indeks mangler</strong>
        <p>Klikk knappen under for √• opprette indeksen i Firebase Console:</p>
        <a id="createIndexLink" href="#" target="_blank" class="btn btn-warning">üîß Opprett indeks i Firebase Console</a>
        <p style="margin-top:8px; font-size:12px;"><em>Etter opprettelse (1‚Äì2 min), last siden p√• nytt.</em></p>
      </div>

      <div id="appContent" style="display:none;">
        <div id="editingNotice" class="editing-notice">
          <strong>Redigerer tur:</strong> Endre verdier og klikk "Lagre endringer".
          <button onclick="cancelEdit()" style="float:right; background:none; border:none; color:#856404; cursor:pointer;">‚úï Avbryt</button>
        </div>

        <h3>Legg til ny tur</h3>
        <div id="autoFillNotice" class="auto-fill-notice" style="display:none;">
          <strong>üöó Smart utfylling:</strong> Km start er automatisk satt til forrige turs slutt-km (<span id="lastKmValue"></span>). Du kan endre dette.
        </div>

        <form id="tripForm">
          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="startDate">Startdato:</label>
                <input type="date" id="startDate" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="startKm">Kilometer start:</label>
                <input type="number" id="startKm" required>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="startLocation">Startsted:</label>
                <input type="text" id="startLocation" required>
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="purpose">Form√•l: <span style="font-weight:400; color:#777;">(valgfritt ved start)</span></label>
                <input type="text" id="purpose" placeholder="Valgfritt ved start">
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="stopLocation">Sluttsted: <span style="font-weight:400; color:#777;">(kan fylles senere)</span></label>
                <input type="text" id="stopLocation" placeholder="Fylles ved m√•l/hjemme">
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="stopDate">Sluttdato: <span style="font-weight:400; color:#777;">(kan fylles senere)</span></label>
                <input type="date" id="stopDate">
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="form-group">
                <label for="stopKm">Kilometer slutt: <span style="font-weight:400; color:#777;">(kan fylles senere)</span></label>
                <input type="number" id="stopKm" placeholder="Fylles senere">
              </div>
            </div>
            <div class="form-col">
              <div class="form-group">
                <label for="initials">Initialer: <span style="font-weight:400; color:#777;">(kan fylles senere)</span></label>
                <select id="initials">
                  <option value="">Velg...</option>
                  <option value="PJI">PJI</option>
                  <option value="LMK">LMK</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-row">
            <div class="form-col">
              <div class="checkbox-group">
                <input type="checkbox" id="roundTrip">
                <label for="roundTrip">Tur/retur</label>
              </div>
            </div>
            <div class="form-col"></div>
          </div>

          <button type="submit" class="btn btn-success" id="submitBtn">Legg til tur</button>
        </form>

        <div class="warning" id="openTripsNotice" style="display:none; margin-top:12px;">
          Det finnes p√•g√•ende (ufullstendige) turer som ikke tas med i PDF-eksport.
        </div>

        <h3 id="tripsHeader" style="margin-top:18px;">Registrerte turer</h3>
        <div class="table-wrapper">
          <table class="records-table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Startdato</th>
                <th>Km start</th>
                <th>Startsted</th>
                <th>Form√•l</th>
                <th>Sluttsted</th>
                <th>Sluttdato</th>
                <th>Km slutt</th>
                <th>T/R</th>
                <th>Kj√∏rt km</th>
                <th class="actions-cell">Handling</th>
              </tr>
            </thead>
            <tbody id="recordsTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import {
      getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, orderBy, query
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import {
      getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile
    } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBY-b720I4Kw_J9RilSXgml66BN05vK3IA",
      authDomain: "vehicle-logbook-ff7c9.firebaseapp.com",
      projectId: "vehicle-logbook-ff7c9",
      storageBucket: "vehicle-logbook-ff7c9.appspot.com",
      messagingSenderId: "693791735958",
      appId: "1:693791735958:web:0b3f780ef71702e8d882b7"
    };

    let app, db, auth, tripsCollection;
    try {
      app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      tripsCollection = collection(db, 'turer');
      console.log('‚úÖ Firebase initialisert');
    } catch (error) {
      console.error('‚ùå Firebase init feil:', error);
      showError('Firebase-initialisering feilet: ' + error.message);
    }

    let trips = [];
    let editingId = null;
    let isSorted = false;
    let currentUser = null;

    window.loginUser = loginUser;
    window.registerUser = registerUser;
    window.logoutUser = logoutUser;
    window.toggleToRegister = () => { document.getElementById('loginForm').style.display='none'; document.getElementById('registerForm').style.display='block'; hideAuthMessages(); };
    window.toggleToLogin = () => { document.getElementById('registerForm').style.display='none'; document.getElementById('loginForm').style.display='block'; hideAuthMessages(); };
    window.deleteTrip = deleteTrip;
    window.editTrip = editTrip;
    window.cancelEdit = cancelEdit;
    window.exportToPDF = exportToPDF;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        document.getElementById('currentUserEmail').textContent = user.email;
        initLogbookApp();
      } else {
        currentUser = null;
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('mainContent').style.display = 'none';
        resetAuthForms();
      }
    });

    function showError(message) {
      document.getElementById('loadingMessage').style.display = 'none';
      document.getElementById('errorMessage').style.display = 'block';
      document.getElementById('errorDetails').textContent = message;
    }
    function showAuthError(message){ document.getElementById('authError').style.display='block'; document.getElementById('authSuccess').style.display='none'; document.getElementById('authErrorMessage').textContent=message; }
    function showAuthSuccess(message){ document.getElementById('authSuccess').style.display='block'; document.getElementById('authError').style.display='none'; document.getElementById('authSuccessMessage').textContent=message; }
    function hideAuthMessages(){ document.getElementById('authError').style.display='none'; document.getElementById('authSuccess').style.display='none'; }
    function resetAuthForms(){
      ['loginEmail','loginPassword','registerEmail','registerPassword','registerName'].forEach(id=>{const el=document.getElementById(id); if(el) el.value='';});
      ['loginBtn','registerBtn'].forEach(id=>{const el=document.getElementById(id); if(el) el.disabled=false;});
      hideAuthMessages();
    }

    async function loginUser(){
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      if(!email || !password){ showAuthError('Vennligst fyll inn b√•de e-post og passord'); return; }
      const btn = document.getElementById('loginBtn'); btn.disabled=true; btn.textContent='Logger inn...';
      try{ await signInWithEmailAndPassword(auth, email, password); showAuthSuccess('Innlogging vellykket!'); }
      catch(error){ 
        let msg='Innlogging feilet';
        if(error.code==='auth/user-not-found') msg='Ingen bruker funnet med denne e-posten';
        else if(error.code==='auth/wrong-password') msg='Feil passord';
        else if(error.code==='auth/invalid-email') msg='Ugyldig e-postadresse';
        else if(error.code==='auth/too-many-requests') msg='For mange fors√∏k. Pr√∏v igjen senere';
        else msg=error.message;
        showAuthError(msg);
        btn.disabled=false; btn.textContent='Logg inn';
      }
    }

    async function registerUser(){
      const email=document.getElementById('registerEmail').value.trim();
      const password=document.getElementById('registerPassword').value;
      const name=document.getElementById('registerName').value.trim();
      if(!email || !password || !name){ showAuthError('Vennligst fyll inn alle feltene'); return; }
      if(password.length<6){ showAuthError('Passordet m√• v√¶re minst 6 tegn'); return; }
      if(!['PJI','LMK'].includes(name.toUpperCase())){ showAuthError('Navn m√• v√¶re enten PJI eller LMK'); return; }
      const btn=document.getElementById('registerBtn'); btn.disabled=true; btn.textContent='Registrerer...';
      try{ const cred=await createUserWithEmailAndPassword(auth,email,password); await updateProfile(cred.user,{displayName:name.toUpperCase()}); showAuthSuccess('Bruker opprettet! Logger inn...'); }
      catch(error){
        let msg='Registrering feilet';
        if(error.code==='auth/email-already-in-use') msg='E-posten er allerede i bruk';
        else if(error.code==='auth/invalid-email') msg='Ugyldig e-postadresse';
        else if(error.code==='auth/weak-password') msg='Passordet er for svakt';
        else msg=error.message;
        showAuthError(msg); btn.disabled=false; btn.textContent='Registrer';
      }
    }

    async function logoutUser(){ try{ await signOut(auth);}catch(e){ alert('Feil ved utlogging: '+e.message);} }

    function initLogbookApp(){
      document.getElementById('exportYear').value = new Date().getFullYear();
      document.getElementById('loadingMessage').style.display='block';
      document.getElementById('errorMessage').style.display='none';
      document.getElementById('indexWarning').style.display='none';
      document.getElementById('appContent').style.display='none';
      setupSortedQuery();
      document.getElementById('tripForm').addEventListener('submit', addOrUpdateTrip);
      setupAutoFillHandlers();
    }

    function setupSortedQuery(){
      try{
        const q = query(tripsCollection, orderBy('startDate','asc'), orderBy('startKm','asc'));
        onSnapshot(q, (snapshot)=>{
          trips=[]; snapshot.forEach(d=>trips.push({id:d.id,...d.data()}));
          isSorted=true;
          render();
        }, (error)=>{
          if(error.code==='failed-precondition'){
            const match = error.message.match(/https:\/\/console\.firebase\.google\.com[^\s]+/);
            const indexUrl = match ? match[0] : 'https://console.firebase.google.com/';
            document.getElementById('createIndexLink').href = indexUrl;
            document.getElementById('indexWarning').style.display='block';
            setupUnsortedQuery();
          } else {
            showError('Database-sp√∏rring feilet: '+error.message);
          }
        });
      } catch(e){ showError('Feil ved sortert sp√∏rring: '+e.message); }
    }

    function setupUnsortedQuery(){
      onSnapshot(collection(db,'turer'), (snapshot)=>{
        trips=[]; snapshot.forEach(d=>trips.push({id:d.id,...d.data()}));
        trips.sort((a,b)=> a.startDate===b.startDate ? (a.startKm||0)-(b.startKm||0) : String(a.startDate).localeCompare(String(b.startDate)));
        isSorted=false;
        render();
      }, (error)=> showError('Alle database-sp√∏rringer feilet: '+error.message));
    }

    function prefillNextTrip(){
      if(trips.length>0){
        const lastTrip = trips.reduce((latest,cur)=> cur.stopKm> (latest.stopKm||-Infinity) ? cur : latest, trips[0]);
        const startKmField=document.getElementById('startKm');
        const autoFillNotice=document.getElementById('autoFillNotice');
        const lastKmValue=document.getElementById('lastKmValue');
        if(!editingId && (!startKmField.value || startKmField.value==='')){
          if(Number.isFinite(lastTrip.stopKm)){
            startKmField.value = lastTrip.stopKm;
            startKmField.classList.add('auto-filled');
            lastKmValue.textContent = `${lastTrip.stopKm} km`;
            autoFillNotice.style.display='block';
          }
        } else {
          autoFillNotice.style.display='none';
        }
      } else {
        document.getElementById('autoFillNotice').style.display='none';
      }
    }

    function setupAutoFillHandlers(){
      const startKmField=document.getElementById('startKm');
      startKmField.addEventListener('input', function(){
        this.classList.remove('auto-filled');
        document.getElementById('autoFillNotice').style.display='none';
      });
    }

    function render(){
      document.getElementById('loadingMessage').style.display='none';
      document.getElementById('appContent').style.display='block';
      loadTrips();
      updateStats();
      prefillNextTrip();
      updateOpenTripsNotice();
      document.getElementById('tripsHeader').textContent = isSorted ? 'Registrerte turer (eldste f√∏rst)' : 'Registrerte turer (sortert i nettleseren)';
    }

    function tripIsComplete(trip){
      // A trip is complete only if it has stopKm and stopDate and stopLocation
      return Number.isFinite(trip.stopKm) && trip.stopKm > (trip.startKm||-Infinity)
             && !!trip.stopDate && !!trip.stopLocation;
    }

    async function addOrUpdateTrip(e){
      e.preventDefault();
      if(!currentUser){ alert('Du m√• v√¶re innlogget for √• lagre'); return; }

      const startDate = document.getElementById('startDate').value;
      const startKmVal = document.getElementById('startKm').value;
      const startKm = startKmVal==='' ? null : parseInt(startKmVal,10);
      const startLocation = document.getElementById('startLocation').value.trim();

      // Minimum krav ved start
      if(!startDate || startKm===null || !Number.isFinite(startKm) || !startLocation){
        alert('Fyll minst ut Startdato, Km start og Startsted.');
        return;
      }

      const stopKmVal = document.getElementById('stopKm').value;
      const stopKm = stopKmVal==='' ? null : parseInt(stopKmVal,10);

      const trip = {
        startDate,
        startKm,
        startLocation,
        purpose: document.getElementById('purpose').value.trim() || '',
        stopLocation: document.getElementById('stopLocation').value.trim() || '',
        stopDate: document.getElementById('stopDate').value || '',
        stopKm: stopKm,
        initials: document.getElementById('initials').value || '',
        roundTrip: document.getElementById('roundTrip').checked,
        updatedAt: new Date().toISOString(),
        updatedBy: currentUser.email
      };

      // Hvis sluttverdier finnes, valid√©r km-logikken
      if (Number.isFinite(trip.stopKm) && trip.stopKm <= trip.startKm) {
        alert('Hvis du fyller inn Km slutt, m√• den v√¶re st√∏rre enn Km start.');
        return;
      }

      try{
        if(editingId){
          await updateDoc(doc(db,'turer',editingId), trip);
          alert('Tur oppdatert!');
          cancelEdit();
        } else {
          trip.createdAt = new Date().toISOString();
          trip.createdBy = currentUser.email;
          trip.createdByName = currentUser.displayName || currentUser.email;
          await addDoc(tripsCollection, trip);
          alert('Tur lagret!');
        }
        document.getElementById('tripForm').reset();
        setTimeout(()=>{ prefillNextTrip(); }, 300);
      } catch(error){
        console.error('Error saving trip:', error);
        alert('Feil ved lagring: ' + error.message);
      }
    }

    function editTrip(id){
      const trip = trips.find(t=>t.id===id);
      if(!trip) return;
      document.getElementById('startDate').value = trip.startDate || '';
      document.getElementById('startKm').value = trip.startKm ?? '';
      document.getElementById('startLocation').value = trip.startLocation || '';
      document.getElementById('purpose').value = trip.purpose || '';
      document.getElementById('stopLocation').value = trip.stopLocation || '';
      document.getElementById('stopDate').value = trip.stopDate || '';
      document.getElementById('stopKm').value = Number.isFinite(trip.stopKm) ? trip.stopKm : '';
      document.getElementById('initials').value = trip.initials || '';
      document.getElementById('roundTrip').checked = !!trip.roundTrip;

      document.getElementById('startKm').classList.remove('auto-filled');
      document.getElementById('autoFillNotice').style.display='none';

      editingId = id;
      document.getElementById('editingNotice').style.display='block';
      document.getElementById('submitBtn').textContent='Lagre endringer';
      document.getElementById('submitBtn').className='btn btn-edit';
      document.getElementById('tripForm').scrollIntoView({behavior:'smooth'});
    }

    function cancelEdit(){
      editingId=null;
      document.getElementById('editingNotice').style.display='none';
      document.getElementById('submitBtn').textContent='Legg til tur';
      document.getElementById('submitBtn').className='btn btn-success';
      document.getElementById('tripForm').reset();
      prefillNextTrip();
    }

    async function deleteTrip(id){
      if(!currentUser){ alert('Du m√• v√¶re innlogget for √• slette'); return; }
      if(confirm('Slette denne turen?')){
        try{ await deleteDoc(doc(db,'turer',id)); }
        catch(e){ alert('Feil ved sletting: '+e.message); }
      }
    }

    function loadTrips(){
      const tbody = document.getElementById('recordsTableBody');
      tbody.innerHTML='';
      trips.forEach(trip=>{
        const complete = tripIsComplete(trip);
        const distance = (Number.isFinite(trip.stopKm) && Number.isFinite(trip.startKm)) ? (trip.stopKm - trip.startKm) : '';
        const roundTripDisplay = trip.roundTrip ? '‚úîÔ∏è' : '-';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${complete ? '<span class="badge badge-complete">Fullf√∏rt</span>' : '<span class="badge badge-open">P√•g√•ende</span>'}</td>
          <td>${formatDate(trip.startDate)}</td>
          <td>${trip.startKm ?? ''}</td>
          <td>${trip.startLocation || ''}</td>
          <td>${trip.purpose || ''}</td>
          <td>${trip.stopLocation || ''}</td>
          <td>${formatDate(trip.stopDate)}</td>
          <td>${Number.isFinite(trip.stopKm) ? trip.stopKm : ''}</td>
          <td>${roundTripDisplay}</td>
          <td>${distance !== '' ? distance : ''}</td>
          <td class="actions-cell">
            <button class="action-btn btn-edit" onclick="editTrip('${trip.id}')">Rediger</button>
            <button class="action-btn btn-danger" onclick="deleteTrip('${trip.id}')">Slett</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function updateStats(){
      const totalTrips = trips.length;
      const totalDistance = trips.reduce((sum, t)=>{
        if(tripIsComplete(t)) return sum + (t.stopKm - t.startKm);
        return sum;
      }, 0);
      document.getElementById('totalTrips').textContent = totalTrips;
      document.getElementById('totalDistance').textContent = totalDistance;
    }

    function updateOpenTripsNotice(){
      const hasOpen = trips.some(t=>!tripIsComplete(t));
      document.getElementById('openTripsNotice').style.display = hasOpen ? 'block' : 'none';
    }

    function formatDate(dateString){
      if(!dateString) return '';
      const date = new Date(dateString);
      if(isNaN(date.getTime())) return dateString;
      return date.toLocaleDateString('no-NO');
    }

    function exportToPDF(){
      const selectedYear = parseInt(document.getElementById('exportYear').value,10);
      if(!selectedYear){ alert('Velg et √•r for eksport'); return; }

      const yearTrips = trips.filter(trip => {
        const d = new Date(trip.startDate);
        return !isNaN(d.getTime()) && d.getFullYear() === selectedYear && tripIsComplete(trip);
      });

      if(yearTrips.length===0){
        alert(`Ingen fullf√∏rte turer funnet for √•r ${selectedYear}`);
        return;
      }

      yearTrips.sort((a,b)=> a.startDate===b.startDate ? (a.startKm||0)-(b.startKm||0) : String(a.startDate).localeCompare(String(b.startDate)));

      let html = `
        <html><head><title>Kj√∏rebok ${selectedYear} - Forest People</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; }
          .header { text-align:center; margin-bottom:20px; }
          .vehicle-info { background:#f0f0f0; padding:10px; margin-bottom:16px; }
          table { width: 100%; border-collapse: collapse; font-size: 12px; }
          th, td { border: 1px solid #000; padding: 5px; text-align: left; white-space: nowrap; }
          th { background: #f0f0f0; }
          .summary { margin-top: 16px; }
        </style></head><body>
        <div class="header">
          <h1>Kj√∏rebok ${selectedYear}</h1>
          <h2>Forest People</h2>
        </div>
        <div class="vehicle-info">
          <strong>Kj√∏ret√∏y:</strong> Toyota Hilux 2010<br>
          <strong>Reg.nr:</strong> PP87332<br>
          <strong>Bedrift:</strong> Forest People
        </div>
        <table><thead><tr>
          <th>Startdato</th><th>Km start</th><th>Startsted</th><th>Form√•l</th>
          <th>Sluttsted</th><th>Sluttdato</th><th>Km slutt</th><th>T/R</th><th>Kj√∏rt km</th><th>Initialer</th>
        </tr></thead><tbody>
      `;

      let totalKm = 0;
      yearTrips.forEach(trip=>{
        const dist = trip.stopKm - trip.startKm;
        totalKm += dist;
        html += `
          <tr>
            <td>${formatDate(trip.startDate)}</td>
            <td>${trip.startKm}</td>
            <td>${trip.startLocation || ''}</td>
            <td>${trip.purpose || ''}</td>
            <td>${trip.stopLocation || ''}</td>
            <td>${formatDate(trip.stopDate)}</td>
            <td>${trip.stopKm}</td>
            <td>${trip.roundTrip ? 'Ja' : ''}</td>
            <td>${dist}</td>
            <td>${trip.initials || ''}</td>
          </tr>
        `;
      });

      html += `
        </tbody></table>
        <div class="summary">
          <h3>Sammendrag ${selectedYear}</h3>
          <p><strong>Antall turer:</strong> ${yearTrips.length}</p>
          <p><strong>Total kj√∏rt:</strong> ${totalKm} km</p>
          <p><strong>Generert:</strong> ${new Date().toLocaleDateString('no-NO')} ${new Date().toLocaleTimeString('no-NO')}</p>
          <p><strong>Generert av:</strong> ${currentUser ? currentUser.email : 'Ukjent bruker'}</p>
          <p style="font-size:10px; color:#666; margin-top:10px;">
            <em>Data sortert ${isSorted ? 'av database' : 'i nettleser'} ‚Ä¢ Sikret med Firebase Authentication</em>
          </p>
        </div>
      </body></html>`;

      const w = window.open('', '_blank');
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    document.getElementById('loginEmail').addEventListener('keypress', e=>{ if(e.key==='Enter') loginUser(); });
    document.getElementById('loginPassword').addEventListener('keypress', e=>{ if(e.key==='Enter') loginUser(); });
    document.getElementById('registerPassword').addEventListener('keypress', e=>{ if(e.key==='Enter') registerUser(); });
  </script>
</body>
</html>
